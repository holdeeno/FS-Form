<script>

  // Prevent forms from submitting.
  function preventFormSubmit() {
    var forms = document.querySelectorAll('form');
    for (var i = 0; i < forms.length; i++) {
      forms[i].addEventListener('submit', function(event) {
      event.preventDefault();
      });
    }
  }
  window.addEventListener("load", functionInit, true); 
  
  // INITIALIZE FUNCTIONS ONLOAD
  function functionInit(){  
    preventFormSubmit();
  };      


  /*
  # PROCESSING FORM -------------------------------------start--------------------------------------------
  */

  // HANDLE FORM SUBMISSIONS
  var submitCounter = 0; // submitCounter keeps track of the number of form submissions. Set equal to zero on intial form load.

  function handleFormSubmit(formObject) {

    submitCounter++;


    if (submitCounter == 1) {

      google.script.run.processInitialEntryForm(formObject);
      document.getElementById("myForm").reset();

    } else if (submitCounter == 2) {

      // This returns the matching field list array if the server-side function 'processSecondEntryForm()' returns succesfully
      function onSuccess(secondEntryFormResponses) { 
        console.log(secondEntryFormResponses);
        const myMatchingFields = secondEntryFormResponses[0];
        console.log(myMatchingFields);
        const myFormTwoArray = secondEntryFormResponses[1];
        console.log(myFormTwoArray);

        // hide the field
        for (const element of myMatchingFields) {
          console.log(element);
          document.getElementById(element).parentNode.style.display = "none";
        }
        // insert value into 
        for (const element of myFormTwoArray) {
          console.log(element);
          console.log(element[0]);
          console.log(element[1]);
          document.getElementById(element[0]).value = element[1];
        }
        
      }

      google.script.run.withSuccessHandler(onSuccess).processSecondEntryForm(formObject);
      
    } else if (submitCounter == 3) {

      google.script.run.processFinalForm(formObject);
      document.getElementById("myForm").reset();

      document.getElementById("myForm").style.display = "none"; // hide the form
      let myElm = document.createElement("p"); // Create a new paragraph element
      myElm.innerText = "Thanks for filling out the form. You can close this window."; // Add message
      document.body.appendChild(myElm);

    }
  }

  /*
  # PROCESSING FORM ---------------------------------------end------------------------------------------
  */

</script>